# TRD
프로젝트명: Next.js + TipTap 기반 Markdown 에디터

## 1. 문서 목적
본 문서는 기능 요구서(PRD)를 기반으로
Next.js와 TipTap을 사용하여 구현된 Markdown 에디터의
기술적 설계와 구현 요구사항을 정의한다.
본 문서는 개발자, 리뷰어, 유지보수 담당자를 위한 기술 문서이다.

---

## 2. 전체 아키텍처 개요

### 2.1 구성 요소
- Client
  - Next.js App Router
  - TipTap Editor
  - Markdown 상태 관리
- Server
  - Next.js API Route
  - 이미지 업로드 처리
- Storage
  - 로컬 파일 시스템 (public/uploads)

### 2.2 데이터 흐름 개요
1. 사용자가 에디터에서 콘텐츠를 입력한다.
2. TipTap이 내부 상태를 갱신한다.
3. 변경 이벤트 발생 시 Markdown 문자열로 직렬화한다.
4. Markdown 상태는 저장 또는 파일 다운로드에 사용된다.
5. 이미지 업로드 시 서버 API를 통해 파일을 저장한다.

---

## 3. 에디터 기술 설계

### 3.1 TipTap 초기화
- useEditor 훅을 사용하여 에디터 인스턴스를 생성한다.
- StarterKit을 기본으로 사용하되 기본 코드블럭 기능은 비활성화한다.
- CodeBlockLowlight 확장을 사용하여 코드블럭을 처리한다.
- Markdown 확장을 활성화하여 Markdown 입출력을 지원한다.

### 3.2 Markdown 처리 방식
- 에디터 업데이트 시 Markdown 직렬화를 수행한다.
- Markdown 문자열은 단일 상태 값으로 관리한다.
- Markdown을 에디터에 반영할 때는
  Markdown 문자열을 그대로 content로 전달한다.

---

## 4. 코드블럭 기술 설계

### 4.1 코드블럭 확장 구조
- 기본 코드블럭 대신 CodeBlockLowlight 확장을 사용한다.
- lowlight를 통해 언어별 하이라이트를 적용한다.

### 4.2 지원 언어 등록
- lowlight core를 사용하여 필요한 언어만 선택적으로 등록한다.
- 등록 대상 언어:
  - javascript
  - typescript
  - json
  - bash
  - html

### 4.3 저장 시 보장 사항
- 코드블럭은 Markdown 직렬화 시
  fenced code block 규칙을 만족하는 구조로 변환되어야 한다.
- 코드 내용과 언어 정보는 손실 없이 유지되어야 한다.

설명용 구조 예시:

    언어 식별자
    코드 내용
    코드 내용

---

## 5. 이미지 처리 기술 설계

### 5.1 업로드 방식
- 모든 이미지는 서버 업로드 방식을 사용한다.
- base64 이미지는 저장하지 않는다.
- 외부 URL 이미지는 업로드 성공 시에만 허용한다.

### 5.2 API 처리 흐름
1. 클라이언트에서 FormData 생성
2. POST 요청으로 이미지 전송
3. 서버에서 파일 검증
4. 파일명 정제 및 저장
5. 접근 가능한 URL 반환

### 5.3 파일 저장 규칙
- 저장 경로는 public/uploads 디렉토리이다.
- 파일명은 timestamp 기반으로 생성한다.
- 파일명 내 특수 문자는 제거 또는 치환한다.

---

## 6. 드래그 앤 드롭 및 붙여넣기 처리

### 6.1 이벤트 가로채기
- editorProps의 handlePaste와 handleDrop을 사용한다.
- 기본 에디터 삽입 동작은 차단한다.

### 6.2 붙여넣기 처리 로직
- 클립보드 내 이미지 파일을 우선 처리한다.
- HTML 콘텐츠에 포함된 이미지 태그를 분석한다.
- data URL 이미지는 File 객체로 변환한다.
- 외부 URL 이미지는 fetch 가능할 경우만 처리한다.

### 6.3 중복 삽입 방지
- 단일 이벤트 내 중복 이미지를 Set 기반으로 필터링한다.
- 기본 paste 동작을 차단하여 이중 삽입을 방지한다.

---

## 7. Markdown 직렬화 정책

### 7.1 코드블럭 직렬화
- 코드블럭은 fenced code block 규칙을 만족해야 한다.
- 언어 식별자는 유지되어야 한다.

### 7.2 이미지 직렬화
- 이미지 노드는 Markdown 이미지 문법으로 변환한다.

설명용 구조 예시:

    ![](/uploads/image.png)

---

## 8. 서버 API 기술 명세

### 8.1 이미지 업로드 API
- Method: POST
- Endpoint: /api/upload
- Content Type: multipart/form-data

### 8.2 서버 런타임
- Node.js 런타임을 사용한다.
- 파일 시스템 접근을 허용한다.

### 8.3 오류 처리
- 업로드 실패 시 HTTP 400을 반환한다.
- 예외는 서버 로그에 기록한다.

---

## 9. 성능 및 안정성 고려사항

### 9.1 성능
- 에디터 업데이트 시 Markdown 직렬화는 비동기로 처리한다.
- 대용량 이미지 업로드 시 UI 블로킹을 최소화한다.

### 9.2 안정성
- 붙여넣기 및 드롭 중 오류 발생 시
  에디터 상태가 손상되지 않아야 한다.
- 에디터는 항상 편집 가능한 상태를 유지해야 한다.

---

## 10. 확장 고려사항
- 이미지 저장소를 외부 오브젝트 스토리지로 교체 가능해야 한다.
- Markdown 포맷은 향후에도 변경되지 않아야 한다.
- 모바일 WebView 환경에서도 동일하게 동작해야 한다.
